@model InventarioLPS.Models.Inventario.CreateRegistroInventarioViewModel

@{
    ViewData["Title"] = "Nuevo registro de inventario";
}

@* — MODAL PARA DUPLICAR N VECES — *@
<div class="modal" id="duplicaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Número de duplicados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">¿Cuántas copias desea crear?</label>
                    <input type="number" id="duplicaCount" min="1" max="20" value="1"
                           class="form-control input-sm" required />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-form"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" id="confirmDuplica"
                        class="btn btn-primary btn-form">
                    Duplicar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    var productInfo = @Html.Raw(Model.ProductInfoJson);
</script>

@* — TEMPLATE PARA CLONAR FILAS — *@
<template id="row-template">
    <tr>
        @* BOTONES PARA ELIMINAR O DUPLICAR FILA*@
        <td class="fs-td">
            <button type="button" class="btn btn-sm btn-outline-primary btn-duplicate-row px-2 py-1">
                <i class="bi bi-copy"></i>
            </button>
            <button type="button" class="btn btn-sm btn-danger btn-remove-row px-2 py-1">
                <i class="bi bi-x-circle"></i>
            </button>
        </td>
        @* CHECKBOX PARA CADA FILA *@
        <td class="fs-td">
            <input type="checkbox" class="row-select form-check-input" />
        </td>
        @* CodigoItem *@
        <td class="fs-td td-codigo">
            <input name="Items[__idx__].CodigoItem" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
        @* Cantidad *@
        <td class="fs-td td-cantidad">
            <input type="number" name="Items[__idx__].Cantidad" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
		@* ValorsinIVA *@
        <td class="fs-td td-valor">
            <input type="number" step="0.01" name="Items[__idx__].ValorSinIva" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
		@* Proveedor *@
        <td class="fs-td td-proveedor">
            <select name="Items[__idx__].ProveedorId" class="form-select input-sm">
                <option value="">-- Seleccione --</option>
                @foreach (var o in Model.ProveedoresOptions)
                {
                    <option value="@o.Value">@o.Text</option>
                }
            </select>
            <span class="text-danger form-control-sm"></span>
        </td>
        @* Producto *@
        <td class="fs-td td-producto">
            <select name="Items[__idx__].CodigoProducto" class="form-select input-sm">
                <option value="">-- Seleccione --</option>
                @foreach (var o in Model.ProductosOptions)
                {
                    <option value="@o.Value">@o.Text</option>
                }
            </select>
            <span class="text-danger form-control-sm"></span>
        </td>
        @* Departamento *@
        <td class="fs-td td-departamento">
            <input name="Items[__idx__].Departamento" readonly class="form-control input-sm departamento-field" />
        </td>
        @* Categoria *@
        <td class="fs-td td-categoria">
            <input name="Items[__idx__].Categoria" readonly class="form-control input-sm categoria-field" />
        </td>
		@* LineaServicio *@
        <td class="fs-td td-linea">
            <input name="Items[__idx__].LineaServicio" readonly class="form-control input-sm linea-field" />
        </td>
		@* SubLineaServicio *@
        <td class="fs-td td-sublinea">
            <input name="Items[__idx__].SubLineaServicio" readonly class="form-control input-sm sublinea-field" />
        </td>
        @* DescripcionEspecifica *@
        <td class="fs-td td-descripcion">
            <input name="Items[__idx__].DescripcionEspecifica" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
		@* EspecificacionesTecnicas *@
        <td class="fs-td td-especificaciones">
            <input name="Items[__idx__].EspecificacionesTecnicas" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
		@* NumeroParteFabricante *@
        <td class="fs-td td-parte">
            <input name="Items[__idx__].NumeroParteFabricante" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
		@* NumeroSerieLps *@
        <td class="fs-td td-serie">
            <input name="Items[__idx__].NumeroSerieLps" class="form-control input-sm" />
            <span class="text-danger form-control-sm"></span>
        </td>
        @* Ubicacion *@
        <td class="fs-td td-ubicacion">
            <select name="Items[__idx__].UbicacionId" class="form-select input-sm">
                <option value="">-- Seleccione --</option>
                @foreach (var o in Model.UbicacionesOptions)
                {
                    <option value="@o.Value">@o.Text</option>
                }
            </select>
            <span class="text-danger form-control-sm"></span>
        </td>
		@* Estatus *@
        <td class="fs-td td-estatus">
            <select name="Items[__idx__].Estatus" class="form-select input-sm">
                <option value="">-- Seleccione --</option>
                @foreach (var o in Model.EstatusOptions)
                {
                    <option value="@o.Value">@o.Text</option>
                }
            </select>
            <span class="text-danger form-control-sm"></span>
        </td>
		@* Clasificacion *@
        <td class="fs-td td-clasificacion">
            <select name="Items[__idx__].ClasificacionId" class="form-select input-sm">
                <option value="">-- Seleccione --</option>
                @foreach (var o in Model.ClasificacionesOptions)
                {
                    <option value="@o.Value">@o.Text</option>
                }
            </select>
            <span class="text-danger form-control-sm"></span>
        </td>
    </tr>
</template>


<h5 class="ps-1">@ViewData["Title"]</h5>

<form asp-action="Create" class="container-fluid border-top border-start">
    <div class="row mt-3">
        <div class="col-12">
            <button type="submit" class="btn btn-primary btn-form">Guardar</button>
        </div>
    </div>

    <div class="row mx-2 mt-1">
        <div class="col-8 col-md-6 col-lg-2">
            <label asp-for="MontoTotal" class="form-label label-sm"></label>
            <input asp-for="MontoTotal" class="form-control input-sm" />
            <span asp-validation-for="MontoTotal" class="text-danger label-sm"></span>
        </div>
        <div class="col-8 col-md-6 col-lg-3">
            <label asp-for="NumeroDocumento" class="form-label label-sm">No. Documento</label>
            <input asp-for="NumeroDocumento" class="form-control input-sm" />
            <span asp-validation-for="NumeroDocumento" class="text-danger label-sm"></span>
        </div>
        <div class="w-100 d-md-none"></div>
        <div class="col-8 col-md-6 col-lg-4">
            <label asp-for="FormaRegistroId" class="form-label label-sm">Forma de registro</label>
            <select asp-for="FormaRegistroId" asp-items="Model.FormasRegistroOptions"
                    class="form-select input-sm">
                <option value="">-- Seleccione --</option>
            </select>
            <span asp-validation-for="FormaRegistroId" class="text-danger label-sm"></span>
        </div>
        <div class="col-8 col-md-6 col-lg-3">
            <label asp-for="FechaCompra" class="form-label label-sm"></label>
            <input asp-for="FechaCompra" class="form-control input-sm" />
            <span asp-validation-for="FechaCompra" class="text-danger label-sm"></span>
        </div>
    </div>

    <hr class="mx-2" />

    <div class="row overflow-auto">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6>Registro de items</h6>
            <div>
                <button type="button" id="btnAddRow" class="btn btn-outline-dark btn-form">
                    <i class="bi bi-plus-lg"></i> Agregar fila
                </button>
                <button type="button" id="btnDeleteSelected" class="btn btn-outline-danger btn-form">
                    <i class="bi bi-trash"></i> Borrar seleccionados
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead class="fs-theader">
                    <tr>
                        <th></th>
                        <th><input type="checkbox" id="selectAllRows" /></th>
                        <th>Código</th>
                        <th>Cantidad</th>
                        <th>Valor sin IVA</th>
                        <th>Proveedor</th>
                        <th>Producto</th>
                        <th>Departamento</th>
                        <th>Categoría</th>
                        <th>Linea de servicio</th>
                        <th>Sub-línea</th>
                        <th>Descrip. específica</th>
                        <th>Especifi. técnicas</th>
                        <th># fabricante</th>
                        <th># serie LPS</th>
                        <th>Ubicación</th>
                        <th>Estatus</th>
                        <th>Clasificación</th>
                    </tr>
                </thead>
                <tbody id="tbodyItems" class="fs-tbody">
                    @* filas generadas por JS *@
                </tbody>
            </table>
        </div>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function() {
      let rowCount = 0;
      let selectedRowForDuplication = null;
      const $tbody       = $('#tbodyItems');
      const templateHtml = $('#row-template').html();

      function addRow(data = {}) {
        let html = templateHtml.replace(/__idx__/g, rowCount);
        const $row = $(html);

        // Rellenar datos si vienen (para duplicar)
        for (let key in data) {
          const $el = $row.find(`[name="Items[${rowCount}].${key}"]`);
          if ($el.length) $el.val(data[key]).trigger('change');
        }

        $tbody.append($row);
        rowCount++;
      }

      // Agregar fila vacía
      $('#btnAddRow').click(() => addRow());

      // Seleccionar todo / deseleccionar
      $('#selectAllRows').change(function(){
        $tbody.find('.row-select').prop('checked', this.checked);
      });

      // Borrar filas seleccionadas
      $('#btnDeleteSelected').click(() => {
        $tbody.find('.row-select:checked').closest('tr').remove();
      });

      // Borrar fila individual
      $(document).on('click', '.btn-remove-row', function(){
        $(this).closest('tr').remove();
      });

      // Preparar duplicación (abrir modal)
      $(document).on('click', '.btn-duplicate-row', function(){
        selectedRowForDuplication = $(this).closest('tr');
        $('#duplicaModal').modal('show');
      });

      // Confirmar duplicación N veces
      $('#confirmDuplica').click(() => {
        const count = Math.min(Math.max(1, parseInt($('#duplicaCount').val())||1), 20);
        const data = {};
        selectedRowForDuplication
          .find('input[name], select[name]')
          .each(function(){
            let name = $(this).attr('name').split('.').pop();
            data[name] = $(this).val();
          });

        for (let i = 0; i < count; i++) {
          addRow(data);
        }
        $('#duplicaModal').modal('hide');
      });

      // Al cambiar producto, rellenar dependientes
      $(document).on('change', 'select[name$=".CodigoProducto"]', function(){
        const code = $(this).val(), info = productInfo[code] || {};
        const $r = $(this).closest('tr');
        $r.find('.departamento-field').val(info.Departamento || '');
        $r.find('.categoria-field') .val(info.Categoria    || '');
        $r.find('.linea-field')     .val(info.LineaServicio|| '');
        $r.find('.sublinea-field')  .val(info.SubLineaServicio|| '');
      });

      // Inicial: agrego la primera fila
      addRow();
    });
</script>
